<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow">
    <script>
        if (!sessionStorage.getItem('laverie_auth')) {
            window.location.href = '/admin/login.html';
        }
    </script>
    <title>Commandes & Boutique - Laverie Lens</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Instrument Sans', sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        a {
            text-decoration: none;
            color: #2d6a4f;
            font-weight: 500;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }

        h2 {
            margin-top: 0;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f9f9f9;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #fcfcfc;
        }

        .status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            background: #eee;
        }

        .status.new {
            background: #e6f4ea;
            color: #1e8e3e;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #666;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            background: #2d6a4f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background: #1b4332;
        }

        /* Order Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            font-size: 1.5rem;
        }
    </style>
</head>

<body>

    <header>
        <div class="container">
            <h1>Administration Boutique</h1>
            <nav>
                <a href="/admin/">Retour Site</a>
            </nav>
        </div>
    </header>

    <div class="container">

        <!-- Product Management -->
        <div class="section">
            <h2>Gestion Produit (Kit Sneakers)</h2>
            <form id="productForm">
                <div class="form-row">
                    <div>
                        <label>Nom du produit</label>
                        <input type="text" id="p-name">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Prix (€)</label>
                        <input type="number" step="0.01" id="p-price">
                    </div>
                </div>
                <div>
                    <label>Description courte (Technique)</label>
                    <textarea id="p-desc" rows="2"></textarea>
                </div>
                <div style="margin-top: 15px;">
                    <label>Sous-titre (Intro marketing)</label>
                    <textarea id="p-subtitle" rows="3"></textarea>
                </div>
                <div class="form-row" style="margin-top: 15px;">
                    <div>
                        <label>Texte avis (ex: 4.9 · 47 avis)</label>
                        <input type="text" id="p-rating-text">
                    </div>
                    <div>
                        <label>Citation client</label>
                        <input type="text" id="p-rating-quote">
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        Points forts (Features)
                        <button type="button" onclick="addFeature()" style="padding: 2px 10px; font-size: 0.8rem;">+
                            Ajouter</button>
                    </label>
                    <div id="featuresList" style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
                        <!-- Features will be loaded here -->
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label>Images du produit (3 max)</label>
                    <div class="form-row">
                        <div>
                            <label style="font-size: 0.8rem;">Image 1 (Principale)</label>
                            <input type="file" id="p-img1" accept="image/*">
                            <input type="hidden" id="p-img1-url">
                            <img id="preview-img1" src="" style="height: 50px; margin-top: 5px; display: none;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem;">Image 2</label>
                            <input type="file" id="p-img2" accept="image/*">
                            <input type="hidden" id="p-img2-url">
                            <img id="preview-img2" src="" style="height: 50px; margin-top: 5px; display: none;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem;">Image 3</label>
                            <input type="file" id="p-img3" accept="image/*">
                            <input type="hidden" id="p-img3-url">
                            <img id="preview-img3" src="" style="height: 50px; margin-top: 5px; display: none;">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px; text-align: right;">
                    <button type="submit">Enregistrer les changements</button>
                </div>
            </form>
            <p id="save-msg" style="display:none; color: green; margin-top: 10px;">Enregistrement en cours...</p>
        </div>

        <!-- Orders -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Dernières Commandes</h2>
                <button onclick="loadOrders()" style="background: #eee; color: #333;">Rafraîchir</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Ref</th>
                        <th>Client</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="6">Chargement...</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <span class="close-btn"
                onclick="document.getElementById('orderModal').classList.remove('active')">&times;</span>
            <h2 id="m-ref">Commande #</h2>
            <p id="m-date" style="color: #666; font-size: 0.9rem; margin-top: -10px;"></p>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <label>Statut de la commande</label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <select id="m-status-select" style="flex: 1; padding: 8px;">
                        <option value="En attente">En attente</option>
                        <option value="Commandée">Commandée</option>
                        <option value="Expédiée">Expédiée</option>
                        <option value="Annulée">Annulée</option>
                    </select>
                    <button id="m-status-btn" style="white-space: nowrap; font-size: 0.9rem;">Mettre à jour</button>
                </div>
            </div>

            <div id="modal-body-content">
                <p><strong>Client:</strong> <span id="m-client"></span></p>
                <div id="m-email"></div>
                <p><strong>Adresse:</strong> <span id="m-address"></span></p>
                <p><strong>Total:</strong> <span id="m-total" style="font-weight: 600;"></span></p>
                <hr>
                <ul id="m-items" style="list-style: none; padding: 0;"></ul>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <button id="m-delete-btn"
                    style="background: #fee2e2; color: #ef4444; width: 100%; border: 1px solid #fecaca;">Supprimer la
                    commande</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let products = [];
        let orders = [];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProduct();
            loadOrders();
        });

        async function loadProduct() {
            try {
                const res = await fetch('/api/shop');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                products = await res.json();

                // If no products exist yet, initialize with a default template
                if (!products || products.length === 0) {
                    console.warn("No products found, initializing empty form.");
                    products = [{
                        id: 1,
                        name: "",
                        price: 0,
                        description: "",
                        images: [],
                        features: []
                    }];
                }

                const product = products[0];
                document.getElementById('p-name').value = product.name || '';
                document.getElementById('p-price').value = product.price || 0;
                document.getElementById('p-desc').value = product.description || '';
                document.getElementById('p-subtitle').value = product.subtitle || '';
                document.getElementById('p-rating-text').value = product.rating_text || '';
                document.getElementById('p-rating-quote').value = product.rating_quote || '';

                // Load features
                renderFeatures(product.features || []);

                // Load images
                if (product.images) {
                    for (let i = 1; i <= 3; i++) {
                        const url = product.images[i - 1];
                        const preview = document.getElementById(`preview-img${i}`);
                        const urlInput = document.getElementById(`p-img${i}-url`);
                        if (url && preview && urlInput) {
                            urlInput.value = url;
                            preview.src = url;
                            preview.style.display = 'block';
                        }
                    }
                }
            } catch (e) {
                console.error("Failed to load product for admin:", e);
                alert('Erreur lors du chargement des produits : ' + e.message);
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/orders');
                orders = await res.json();
                renderOrders();
            } catch (e) {
                console.error(e);
            }
        }

        function renderOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 30px;">Aucune commande pour le moment.</td></tr>';
                return;
            }

            orders.slice().reverse().forEach(order => {
                const tr = document.createElement('tr');
                const date = new Date(order.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                const statusClass = order.status === 'En attente' ? 'new' : '';

                // Handle legacy 'name' vs new 'firstname'/'lastname'
                let clientName = order.customer.name || `${order.customer.firstname} ${order.customer.lastname}`;

                const displayId = String(order.id).startsWith('CMD-') ? order.id : `CMD-${order.id}`;

                tr.innerHTML = `
                    <td>${date}</td>
                    <td>${displayId}</td>
                    <td>${clientName}</td>
                    <td><strong>${order.total}</strong></td>
                    <td><span class="status ${statusClass}">${order.status}</span></td>
                    <td><button style="padding: 5px 10px; font-size: 0.8rem;" onclick="viewOrder('${order.id}')">Voir</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function uploadImage(fileInputId) {
            const input = document.getElementById(fileInputId);
            if (!input.files || input.files.length === 0) return null;

            const file = input.files[0];
            const formData = new FormData(); // Not used by backend, raw body used

            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    headers: {
                        'x-filename': 'prod-' + Date.now() + '-' + file.name
                    },
                    body: file
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.path;
                }
            } catch (e) {
                console.error('Upload failed', e);
            }
            return null;
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (products.length === 0) return;

            const msg = document.getElementById('save-msg');
            msg.textContent = "Sauvegarde en cours...";
            msg.style.display = 'block';
            msg.style.color = 'blue';

            // 1. Upload new images if present
            const img1New = await uploadImage('p-img1');
            const img2New = await uploadImage('p-img2');
            const img3New = await uploadImage('p-img3');

            // 2. Build image array (keep old if no new upload)
            const currentImages = products[0].images || [];
            const finalImages = [
                img1New || document.getElementById('p-img1-url').value || currentImages[0],
                img2New || document.getElementById('p-img2-url').value || currentImages[1],
                img3New || document.getElementById('p-img3-url').value || currentImages[2]
            ].filter(url => url); // Remove undefined/null/empty strings

            // 3. Update Product Object
            products[0].name = document.getElementById('p-name').value;
            products[0].price = parseFloat(document.getElementById('p-price').value);
            products[0].description = document.getElementById('p-desc').value;
            products[0].subtitle = document.getElementById('p-subtitle').value;
            products[0].rating_text = document.getElementById('p-rating-text').value;
            products[0].rating_quote = document.getElementById('p-rating-quote').value;
            products[0].images = finalImages;

            // Collect features
            const features = [];
            document.querySelectorAll('.feature-item').forEach(item => {
                features.push({
                    icon: item.querySelector('.f-icon').value,
                    title: item.querySelector('.f-title').value,
                    subtitle: item.querySelector('.f-subtitle').value
                });
            });
            products[0].features = features;

            try {
                await fetch('/api/shop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(products)
                });
                msg.textContent = "Enregistré !";
                msg.style.color = 'green';
                setTimeout(() => msg.style.display = 'none', 3000);

                // Reload to refresh previews
                loadProduct();

            } catch (e) {
                alert('Erreur sauvegarde');
                msg.style.display = 'none';
            }
        });

        window.viewOrder = function (id) {
            const order = orders.find(o => String(o.id) === String(id));
            if (!order) return;

            const displayId = String(order.id).startsWith('CMD-') ? order.id : `CMD-${order.id}`;
            document.getElementById('m-ref').textContent = 'Commande #' + displayId;
            document.getElementById('m-date').textContent = new Date(order.date).toLocaleString('fr-FR');

            // Status select
            const statusSelect = document.getElementById('m-status-select');
            statusSelect.value = order.status;

            let clientName = order.customer.name || `${order.customer.firstname} ${order.customer.lastname}`;
            document.getElementById('m-client').textContent = clientName;

            // Add Phone check
            const phone = order.customer.phone ? `<p><strong>Tél:</strong> ${order.customer.phone}</p>` : '';

            document.getElementById('m-email').innerHTML = `<p><strong>Email:</strong> ${order.customer.email}</p> ${phone}`;
            document.getElementById('m-address').textContent = order.customer.address;
            document.getElementById('m-total').textContent = order.total;

            const itemsList = document.getElementById('m-items');
            itemsList.innerHTML = '';
            order.items.forEach(item => {
                const li = document.createElement('li');
                li.style.cssText = "padding: 10px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between;";
                li.innerHTML = `<span>${item.name} (x${item.qty})</span> <span>${(item.price * item.qty).toFixed(2)} €</span>`;
                itemsList.appendChild(li);
            });

            // Status Update Button
            document.getElementById('m-status-btn').onclick = async () => {
                const newStatus = statusSelect.value;
                try {
                    const res = await fetch('/api/orders', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: order.id, status: newStatus })
                    });
                    if (res.ok) {
                        alert('Statut mis à jour');
                        loadOrders();
                    } else {
                        alert('Erreur lors de la mise à jour');
                    }
                } catch (e) {
                    console.error(e);
                }
            };

            // Delete Button
            document.getElementById('m-delete-btn').onclick = async () => {
                if (!confirm('Êtes-vous sûr de vouloir supprimer cette commande ? Cette action est irréversible.')) return;

                try {
                    const res = await fetch('/api/orders', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: order.id })
                    });
                    if (res.ok) {
                        document.getElementById('orderModal').classList.remove('active');
                        loadOrders();
                    } else {
                        alert('Erreur lors de la suppression');
                    }
                } catch (e) {
                    console.error(e);
                }
            };

            document.getElementById('orderModal').classList.add('active');
        }

        // --- FEATURES MANAGEMENT ---
        function renderFeatures(features) {
            const container = document.getElementById('featuresList');
            container.innerHTML = '';
            features.forEach((f, i) => addFeature(f));
        }

        function addFeature(data = { icon: '✨', title: '', subtitle: '' }) {
            const container = document.getElementById('featuresList');
            const div = document.createElement('div');
            div.className = 'feature-item';
            div.style.cssText = "display: flex; gap: 10px; background: #fafafa; padding: 10px; border-radius: 6px; border: 1px solid #eee; align-items: start;";
            div.innerHTML = `
                <input type="text" class="f-icon" value="${data.icon}" style="width: 40px; text-align: center;" placeholder="Icon">
                <div style="flex: 1; display: flex; flex-direction: column; gap: 5px;">
                    <input type="text" class="f-title" value="${data.title}" placeholder="Titre (ex: Spray Expert)">
                    <textarea class="f-subtitle" rows="2" style="font-size: 0.8rem;" placeholder="Description">${data.subtitle}</textarea>
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="background: #fee2e2; color: #ef4444; padding: 5px; border-radius: 4px;">&times;</button>
            `;
            container.appendChild(div);
        }
    </script>
</body>

</html>